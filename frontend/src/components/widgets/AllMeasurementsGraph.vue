<template>
	<div id="chart">
		<div class="toolbar q-gutter-md row justify-end">
			<!-- <q-btn outline color="primary" icon="navigate_before" /> -->
			<q-select
				filled
				v-model="selected"
				use-input
				input-debounce="0"
				label="Probe ID"
				:options="options"
				@filter="filterFn"
				style="width: 250px"
			>
				<template v-slot:no-option>
					<q-item>
						<q-item-section class="text-grey">
							No results
						</q-item-section>
					</q-item>
				</template>
			</q-select>
			<!-- <q-btn outline color="primary" icon="navigate_next" /> -->
		</div>
		<apexchart
			type="area"
			height="350"
			ref="chart"
			:options="chartOptions"
			:series="series"
		></apexchart>
	</div>
</template>

<script>
import { ref } from "vue";
var probes = [1337, 1234, 56789];

export default {
	setup() {
		var options = ref(probes);

		return {
			selected: ref(null),
			options,
			
			filterFn(val, update) {
				update(() => {
					const needle = val.toLowerCase();
					options.value = probes.filter(
						v => v.toString().toLowerCase().indexOf(needle) > -1
					);
				});
			}
		};
	},
	data() {
		return {
			chartOptions: {
				chart: {
					id: "area-datetime",
					type: "area",
					height: 350,
					zoom: {
						autoScaleYaxis: false
					}
				},
				annotations: {
					xaxis: []
				},
				dataLabels: {
					enabled: false
				},
				markers: {
					size: 0,
					style: "hollow"
				},
				tooltip: {
					x: {
						format: "dd MMM yyyy | HH:mm"
					}
				},
				xaxis: {
					type: "datetime",
					labels: {
						datetimeFormatter: {
							year: "yyyy",
							month: "MMM 'yy",
							day: "dd MMM",
							hour: "HH:mm"
						}
					}
				},
				fill: {
					type: "gradient",
					gradient: {
						shadeIntensity: 1,
						opacityFrom: 0.7,
						opacityTo: 0.9,
						stops: [0, 100]
					}
				}
			},
			series: [
				{
					name: "series-1",
					data: []
				}
			]
		};
	},
	created() {
		this.updateChart();
	},
	methods: {
		updateChart() {
			let data = JSON.parse(
				'{"1641773236000":199.397,"1641774134000":199.275,"1641775025000":199.385,"1641775927000":199.408,"1641776822000":199.418,"1641777728000":199.345,"1641778632000":199.523,"1641779526000":199.365,"1641780425000":199.39,"1641781322000":198.964,"1641782231000":198.748,"1641783133000":198.826,"1641784034000":199.029,"1641784933000":198.977,"1641785827000":198.717,"1641786729000":198.938,"1641787622000":198.631,"1641788525000":198.953,"1641789428000":198.687,"1641790325000":198.762,"1641791236000":198.751,"1641792122000":198.687,"1641793028000":198.976,"1641793935000":198.93,"1641794836000":198.886,"1641795736000":199.0,"1641796630000":199.031,"1641797528000":198.842,"1641798431000":198.772,"1641799335000":198.831,"1641800232000":198.716,"1641801127000":198.602,"1641802025000":198.976,"1641802932000":199.069,"1641803833000":198.558,"1641804729000":198.86,"1641805624000":199.069,"1641806529000":198.905,"1641807425000":198.665,"1641808330000":198.736,"1641809223000":198.713,"1641810135000":198.833,"1641811026000":198.511,"1641811926000":198.763,"1641812822000":198.932,"1641813734000":199.062,"1641814627000":198.839,"1641815530000":198.853,"1641816430000":199.042,"1641817329000":198.747,"1641818225000":199.066,"1641819133000":198.796,"1641820035000":199.688,"1641820922000":200.191,"1641821830000":199.86,"1641822730000":200.281,"1641823630000":200.159,"1641824528000":198.934,"1641825435000":199.055,"1641826329000":198.924,"1641827224000":199.027,"1641828124000":198.999,"1641829024000":199.007,"1641829934000":199.003,"1641830834000":199.114,"1641831726000":199.058,"1641832631000":199.076,"1641833529000":198.836,"1641834431000":199.06,"1641835327000":198.857,"1641836233000":199.201,"1641837131000":199.162,"1641838027000":198.975,"1641838925000":199.064,"1641839827000":199.219,"1641840733000":198.841,"1641841634000":198.99,"1641842528000":198.914,"1641843432000":199.103,"1641844332000":199.274,"1641845228000":199.313,"1641846129000":199.473,"1641847023000":199.27,"1641847932000":199.455,"1641848835000":199.44,"1641849731000":199.196,"1641850629000":199.519,"1641851530000":199.301,"1641852435000":199.552,"1641853335000":199.343,"1641854231000":199.474,"1641855123000":199.305,"1641856031000":199.281,"1641856929000":199.686,"1641857832000":199.273,"1641858725000":199.367,"1641859626000":199.618,"1641860535000":199.365,"1641861422000":199.392,"1641862323000":199.154,"1641863227000":199.467,"1641864126000":199.245,"1641865036000":199.136,"1641865924000":199.305,"1641866834000":198.942,"1641867735000":199.088,"1641868624000":199.172,"1641869527000":199.334,"1641870427000":199.023,"1641871332000":199.084,"1641872225000":199.152,"1641873134000":199.406,"1641874025000":199.172,"1641874934000":199.482,"1641875833000":199.029,"1641876732000":199.308,"1641877635000":199.167,"1641878531000":199.432,"1641879425000":199.245,"1641880328000":199.289,"1641881227000":198.889,"1641882124000":199.287,"1641883033000":201.057,"1641883928000":201.065,"1641884827000":201.071,"1641885723000":201.273,"1641886636000":200.94,"1641887534000":199.216,"1641888430000":199.476,"1641889334000":199.364,"1641890231000":199.357,"1641891128000":199.268,"1641892024000":199.453,"1641892923000":199.015,"1641893825000":199.451,"1641894736000":199.127,"1641895625000":198.94,"1641896530000":199.363,"1641897425000":199.152,"1641898325000":199.565,"1641899229000":199.401,"1641900134000":199.151,"1641901036000":199.319}'
			);

			let timeserie = Object.keys(data).map(function(key) {
				return [parseInt(key), data[key]];
			});

			this.series[0].data = timeserie;

			let anomalies = [1641882124000, 1641883033000, 1641883928000];

			let annotations = [];
			for (let i = 0; i < anomalies.length; i++) {
				annotations.push({
					x: anomalies[i],
					strokeDashArray: 0,
					borderWidth: 2,
					borderColor: "#AA0000",
					
				});
			}

			this.chartOptions.annotations.xaxis = annotations;
		}
	}
};
</script>